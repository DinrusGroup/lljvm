#!/bin/sh

set -e

DIR="`dirname "$0"`"
export PATH="$DIR:$PATH"

if   which llvm-gcc >/dev/null; then CC=llvm-gcc
elif which clang    >/dev/null; then CC=clang
else echo "Error: either llvm-gcc or clang must be installed" && exit 1
fi

CFLAGS="-emit-llvm -I$DIR/thirdparty/newlib/newlib/libc/include"
LIBS="libc java.lang.Math lljvm.runtime.System lljvm.runtime.Posix"

SOURCE="$1"
BASENAME="`dirname "$SOURCE"`/`basename "$SOURCE" .c`"

$CC $CFLAGS -c "$SOURCE" -o "$BASENAME.bc"
lljvm-backend "$BASENAME.bc" \
    | java -jar "$DIR/lljvm.jar" ld $LIBS \
    > "$BASENAME.j"
java jasmin.Main "$BASENAME.j"
